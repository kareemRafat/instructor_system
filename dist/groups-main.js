import{capitalizeFirstLetter,getQueryString}from"./helpers.js";const searchInput=document.getElementById("table-search"),tbody=document.querySelector("tbody"),page=getQueryString("page"),branchVal=getQueryString("branch"),pageList=document.getElementById("page-list");function finishGroup(e,t){const n=new FormData,r=(new Date).toLocaleString("sv-SE").replace("T"," ");n.append("group_id",e),n.append("finist_date",r),fetch("functions/Groups/finish_group.php",{method:"POST",body:n}).then((e=>e.json())).then((e=>{if("success"===e.status){t.closest("tr").remove(),notyf.success("Group Finished Successfully")}else alert("Error: "+e.message)})).catch((e=>{alert("An error occurred while finishing the group")}))}function fetchGroups(e,t){fetch(`functions/Groups/get_groups.php?branch_id=${e}`).then((e=>e.json())).then((e=>{setTable(e,t)})).catch((e=>console.error("Error fetching lectures:",e)))}function setTable(e,t=null){tbody.innerHTML="",0==e.data.length&&(tbody.innerHTML='\n        <tr>\n          <td class="px-6 py-4 font-bold bg-white" colspan="7"> No Group Found </td>\n        </tr>\n    '),e.data.forEach((e=>{const t=document.createElement("tr");t.className="bg-white border-b border-gray-200 hover:bg-gray-50",t.innerHTML=`\n      <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">\n          ${e.group_name.charAt(0).toUpperCase()+e.group_name.slice(1)}\n      </th>\n      <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">\n          ${2==e.group_time||5==e.group_time?`${e.group_time} - Friday`:e.group_time}\n      </th>\n      <th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">\n          ${e.group_day}\n      </th>\n      <td class="px-6 py-4">\n          ${e.instructor_name.charAt(0).toUpperCase()+e.instructor_name.slice(1)}\n      </td>\n      <td class="px-6 py-4">\n          ${e.branch_name.charAt(0).toUpperCase()+e.branch_name.slice(1)}\n      </td> \n      <td class="px-6 py-4">\n          <span class="block">${e.month}</span>\n          ${e.formatted_date?e.formatted_date:"No date added"}\n      </td>           \n      <td class="px-6 py-4">\n          <a href="?action=edit&group_id=${e.id}" class="cursor-pointer border border-gray-300 py-1 px-2 rounded-lg font-medium text-blue-600 hover:underline mr-2 inline-block mb-2"><i class="fa-solid fa-pen-to-square mr-2"></i>\n            Edit\n          </a>\n          <button data-group-id="${e.id}" class="finish-group-btn cursor-pointer border border-gray-300 py-1 px-2 rounded-lg font-medium text-red-600 hover:underline">\n              <i class="fa-regular fa-circle-check mr-2"></i>Finish\n          </button>\n      </td>\n  `,tbody.appendChild(t)}))}document.addEventListener("DOMContentLoaded",(function(){fetch("functions/Branches/get_branches.php").then((e=>e.json())).then((e=>{"success"==e.status&&(branchSelect.innerHTML='<option value="" selected>Select a Branch</option>',e.data.forEach((e=>{let t=document.createElement("option");t.value=e.id,t.textContent=capitalizeFirstLetter(e.name),t.value==branchVal&&(t.selected=!0),branchSelect.appendChild(t)})))})).catch((e=>console.error("Error fetching lectures:",e))),searchInput.addEventListener("input",(function(){const e=this.value.trim();let t="";e?pageList.classList.add("hidden"):pageList.classList.remove("hidden"),t=branchVal?`functions/Groups/search_groups.php?search=${encodeURIComponent(e)}&branch_id=${encodeURIComponent(branchVal)}${page?`&page=${encodeURIComponent(page)}`:""}`:`functions/Groups/search_groups.php?search=${encodeURIComponent(e)}${page?`&page=${encodeURIComponent(page)}`:""}`,fetch(t).then((e=>e.json())).then((e=>{setTable(e)})).catch((e=>console.error("Error:",e)))})),tbody.addEventListener("click",(function(e){if(e.target.closest(".finish-group-btn")){const t=e.target.closest(".finish-group-btn"),n=t.dataset.groupId;confirm("Are you sure you want to finish this group?")&&finishGroup(n,t)}}))}));